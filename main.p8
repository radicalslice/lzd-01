pico-8 cartridge // http://www.pico-8.com
version 37
__lua__

#include baddie.lua
#include camera.lua
#include collision.lua
#include game_m.lua
#include player.lua
#include qico.lua
#include rooms.lua

BTN_L = 0
BTN_R = 1
BTN_U = 2
BTN_D = 3
BTN_O = 4
BTN_X = 5

frame_counter = 0
current_room = nil -- points to player's current room
__update = nil
__draw = nil
current_room_col = 1
current_room_row = 1

function game_update()
  frame_counter += 1
  if frame_counter > 1024 then
    frame_counter = 0
  end

  player.update()
  baddie_m.update()

  foreach(baddie_m.baddies, function(b)
    if collides(player, b) then
      q.add_event("collision")
    end

    if player.weapon != nil then
      if collides(player.weapon, b) then
        q.add_event("attacked", {baddie=b})
      end
    end
  end)

  foreach(door_m.doors, function(d)
    if collides(player, d) 
      and player.direction == d.direction 
      and d.state == "open" then
      local new_room_row = 0
      local new_room_col = 0
      if d.direction == 0 then
        new_room_col = -1
      elseif d.direction == 1 then
        new_room_col = 1
      elseif d.direction == 2 then
        new_room_row = -1
      elseif d.direction == 3 then
        new_room_row = 1
      end
      q.add_event("load_room", {new_room_col=new_room_col, new_room_row=new_room_row})
    end
  end)

  foreach(item_m.items, function(item)
    if collides(player, item) then
      q.add_event("get_end_item")
    end
  end)

  cam.update()

  q.proc()
end

function nextroom_update()
  cam.update()
  q.proc()
end

function _init()
  printh("____init____")
  q = qico()
  q.add_topics("collision|attacked|load_room|cammove_start|cammove_done|room_clear|get_end_item")
  q.add_sub("collision", player.handle_collision)
  q.add_sub("attacked", baddie_m.handle_attacked)
  q.add_subs("load_room", {game_m.handle_load_room, player.handle_load_room})
  q.add_sub("cammove_start", cam.handle_cammove_start)
  q.add_sub("cammove_done", game_m.handle_cammove_done)
  q.add_sub("room_clear", door_m.handle_room_clear)
  q.add_sub("get_end_item", game_m.handle_get_end_item)

  current_room = load_room(current_room_row, current_room_col)
  __update = game_update
  __draw = game_draw
end

function game_draw()
  cls()

  camera(cam.x, cam.y)

  map(0,0,0,0,22,22)
  -- map(current_room.start_x,current_room.start_y,0,0,current_room.end_x,current_room.end_y)
  door_m.draw()
  baddie_m.draw()
  item_m.draw()
  player.draw()

  camera()
  rectfill(0,118,127,127,5)
  print("health: "..player.health, 1, 120, 7)

end

function end_update()
end

function end_draw()
  cls()
  print("good job, buddy!", 32, 56, 11)
end

function _draw()
  __draw()
end



function _update60()
  __update()
end


function load_room(row, col)
  printh("load room!")
  printh("row".. row)
  printh("col".. col)
  local new_room = nil
  if rooms[row][col] != nil then
    new_room = rooms[row][col]
    baddie_m.baddies = new_room.baddies
    door_m.doors = new_room.doors
    item_m.items = new_room.items
  end

  return new_room
end

__gfx__
00999900009999000099990000999900000000000000000000000000000000000000000055555555555555555555555555555555555555550000000000000000
0094994444994900004444000094490000000000000000000000000000000000000000005666666656665666555555555ccccccc588888880000000000000000
001c1c0000c1c10000cccc00001cc10000000000000000000000000000000000000000005666666656665666555555555ccccccc588888880000000000000000
00cccc0000cccc0000cccc0000cccc0000000000000000000000000000000000000000005666666656665666555555555ccccccc588888880000000000000000
0999999999999990999999999999999900000000000000000000000000000000000000005666666655555555555555555ccccccc588888880000000000000000
0999999999999990999999999999999900000000000000000000000000000000000000005666666656665666555555555ccccccc588888880000000000000000
0999999009999990099999900999999000000000000000000000000000000000000000005666666656665666555555555ccccccc588888880000000000000000
0770077007700770077007700770077000000000000000000000000000000000000000005666666656665666555555555ccccccc588888880000000000000000
00300300003003000300003003000030000000000000000000000000000000000000000011c0000000000c111111111100000000000000000000000000000000
00333300003333000303303003033030000000000000000000000000000000000000000011c0000000000c111111111100000000000000000000000000000000
00333300003333000033330000333300000000000000000000000000000000000000000011c0000000000c11cccccccc00000000000000000000000000000000
03b733300333b73003333330037bb730000000000000000000000000000000000000000011c0000000000c110000000000000000000000000000000000000000
03bb33300333bb3003355330033bb330000000000000000000000000000000000000000011c0000000000c110000000000000000000000000000000000000000
00333300003333000035530000333300000000000000000000000000000000000000000011c0000000000c1100000000cccccccc000000000000000000000000
00333300003333000033330000333300000000000000000000000000000000000000000011c0000000000c110000000011111111000000000000000000000000
00300300003003000030030000300300000000000000000000000000000000000000000011c0000000000c110000000011111111000000000000000000000000
000000000000000000004000000000000000000000000000000000000000000000000000000000000000000011c0000000000c11000000000000000000000000
000000000000000000040000000000000000000000000000000000000000000000000000000000000000000011c0000000000c11000000000000000000000000
0000000000000000000040000000000000000000000000000000000000000000000000000000000000000000ccc0000000000ccc000000000000000000000000
40404040000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
04040404000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000004000000000000000000000000000000000000000000000000000000000cccccc000000000000000000000000000000000000000000000
00000000000000000000400000000000000000000000000000000000000000000000000000000c1111c000000000000000000000000000000000000000000000
00000000000000000004000000000000000000000000000000000000000000000000000000000c1111c000000000000000000000000000000000000000000000
000cc0000000000000000000000000000000000000000000000000000000000000000000111111111111111111c0000000000c11000000000000000000000000
00c77c000000000000000000000000000000000000000000000000000000000000000000111111111111111111c0000000000c11000000000000000000000000
0c7777c0000000000000000000000000000000000000000000000000000000000000000011cccccccccccc1111c0000000000c11000000000000000000000000
c77cc77c000000000000000000000000000000000000000000000000000000000000000011c0000000000c1111c0000000000c11000000000000000000000000
c77cc77c000000000000000000000000000000000000000000000000000000000000000011c0000000000c1111c0000000000c11000000000000000000000000
0c7777c0000000000000000000000000000000000000000000000000000000000000000011c0000000000c1111cccccccccccc11000000000000000000000000
00c77c00000000000000000000000000000000000000000000000000000000000000000011c0000000000c111111111111111111000000000000000000000000
000cc000000000000000000000000000000000000000000000000000000000000000000011c0000000000c111111111111111111000000000000000000000000
__gff__
0000000000000000000002010202000000000000000000000001010101000000000000000000000000010101010000000000000000000000000101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
291c1c1c1c1c1c1c1c1c2a291c1c1c1c1c1c1c1c2a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a090909090909090909191a0909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a090909090909090909191a0909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a0909090909090909093b3c0909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a09090909090909090909090909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a09090909090909090909090909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a090909090909090909393a0909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a090909090909090909191a0909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a090909090909090909191a0909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a090909090909090909191a0909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2c1b1b1b1b1b1b1b1b1b2b2c1b1b3a0909391b1b2b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404291c1c3c09093b1c1c2a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000001a0909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000001a0909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000001a0909090909090909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000002c1b1b3a0909391b1b2b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000001a0909190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000002c1b1b2b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
